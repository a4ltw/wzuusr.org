name: éƒ¨ç½² MkDocs ç¶²ç«™åˆ° GitHub Pages /n/

on:
  # ç•¶æ¨é€åˆ°ä¸»åˆ†æ”¯æˆ– Claude å·¥ä½œåˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'docs/n/**'
      - 'mkdocs.yml'
      - '.github/workflows/deploy.yml'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¨­ç½® GITHUB_TOKEN æ¬Šé™ä»¥å…è¨±éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# åªå…è¨±ä¸€å€‹ä¸¦ç™¼éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²è¨˜éŒ„ï¼ˆæŸäº›æ’ä»¶éœ€è¦ï¼‰

      - name: è¨­ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: å®‰è£ä¾è³´
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: æ§‹å»º MkDocs ç¶²ç«™
        run: |
          # æ§‹å»ºç¶²ç«™åˆ°è‡¨æ™‚ç›®éŒ„
          mkdocs build --verbose --site-dir temp_site

      - name: æº–å‚™éƒ¨ç½²ç›®éŒ„
        run: |
          # æª¢å‡º gh-pages åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git fetch origin gh-pages --depth=1 || true
          git checkout gh-pages || git checkout --orphan gh-pages

          # ä¿ç•™æ ¹ç›®éŒ„çš„æ–‡ä»¶ï¼ˆindex.html, CNAME ç­‰ï¼‰
          mkdir -p _preserve
          if [ -f "index.html" ]; then cp index.html _preserve/; fi
          if [ -f "CNAME" ]; then cp CNAME _preserve/; fi
          if [ -f ".nojekyll" ]; then cp .nojekyll _preserve/; fi

          # æ¸…ç©ºç•¶å‰ç›®éŒ„ï¼ˆé™¤äº† .gitï¼‰
          git rm -rf . 2>/dev/null || true

          # æ¢å¾©ä¿ç•™çš„æ–‡ä»¶
          if [ -f "_preserve/index.html" ]; then mv _preserve/index.html .; fi
          if [ -f "_preserve/CNAME" ]; then mv _preserve/CNAME .; fi
          if [ -f "_preserve/.nojekyll" ]; then mv _preserve/.nojekyll .; fi
          rm -rf _preserve

          # ç¢ºä¿æœ‰ .nojekyll æ–‡ä»¶ï¼ˆç¦ç”¨ Jekyll è™•ç†ï¼‰
          touch .nojekyll

          # å‰µå»º /n/ ç›®éŒ„ä¸¦ç§»å‹•æ§‹å»ºçš„ç¶²ç«™
          mkdir -p n
          cp -r temp_site/* n/

          # æ¸…ç†è‡¨æ™‚ç›®éŒ„
          rm -rf temp_site

      - name: æäº¤ä¸¦éƒ¨ç½²
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add .
          git diff --staged --quiet || git commit -m "Deploy MkDocs site to /n/ - $(date +'%Y-%m-%d %H:%M:%S')"

          git push origin gh-pages --force

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "âœ… ç¶²ç«™å·²æˆåŠŸéƒ¨ç½²ï¼"
          echo "ğŸ“ æ ¹ç›®éŒ„: https://www.wzuusr.org/ (é‡å®šå‘åˆ° Wix)"
          echo "ğŸ“ æ–°ç¶²ç«™: https://www.wzuusr.org/n/"
